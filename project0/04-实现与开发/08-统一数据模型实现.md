# 统一数据模型实现

## 概述

统一数据模型是IoT系统的核心基础，定义了设备、传感器、事件等关键实体的标准化数据结构。本文档提供基于Rust和Go的统一数据模型实现。

## 核心数据模型

### 1. 设备模型

```rust
use serde::{Deserialize, Serialize};
use std::collections::HashMap;
use chrono::{DateTime, Utc};

/// 设备类型枚举
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum DeviceType {
    Sensor,
    Actuator,
    Gateway,
    Controller,
    Camera,
    Custom(String),
}

/// 设备状态枚举
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum DeviceStatus {
    Online,
    Offline,
    Error,
    Maintenance,
    Disabled,
}

/// 设备位置信息
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Location {
    pub latitude: f64,
    pub longitude: f64,
    pub altitude: Option<f64>,
    pub address: Option<String>,
}

/// 设备能力
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceCapability {
    pub name: String,
    pub version: String,
    pub parameters: HashMap<String, serde_json::Value>,
}

/// 设备信息
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Device {
    pub id: String,
    pub name: String,
    pub device_type: DeviceType,
    pub status: DeviceStatus,
    pub location: Option<Location>,
    pub capabilities: Vec<DeviceCapability>,
    pub metadata: HashMap<String, serde_json::Value>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub last_seen: Option<DateTime<Utc>>,
}
```

### 2. 传感器数据模型

```rust
/// 传感器类型枚举
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum SensorType {
    Temperature,
    Humidity,
    Pressure,
    Light,
    Motion,
    Voltage,
    Current,
    Power,
    Custom(String),
}

/// 传感器数据单位
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum Unit {
    Celsius,
    Fahrenheit,
    Kelvin,
    Percent,
    Pascal,
    Lux,
    Volt,
    Ampere,
    Watt,
    Custom(String),
}

/// 传感器数据质量
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum DataQuality {
    Good,
    Uncertain,
    Bad,
    Invalid,
}

/// 传感器数据点
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SensorData {
    pub id: String,
    pub device_id: String,
    pub sensor_type: SensorType,
    pub value: f64,
    pub unit: Unit,
    pub quality: DataQuality,
    pub timestamp: DateTime<Utc>,
    pub metadata: HashMap<String, serde_json::Value>,
}

/// 传感器配置
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SensorConfig {
    pub sensor_id: String,
    pub name: String,
    pub sensor_type: SensorType,
    pub unit: Unit,
    pub sampling_rate: f64,  // 采样率 (Hz)
    pub range_min: Option<f64>,
    pub range_max: Option<f64>,
    pub accuracy: Option<f64>,
    pub calibration_data: HashMap<String, f64>,
}
```

### 3. 事件模型

```rust
/// 事件类型枚举
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum EventType {
    DeviceOnline,
    DeviceOffline,
    DataReceived,
    Alert,
    Error,
    Maintenance,
    Custom(String),
}

/// 事件严重程度
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum EventSeverity {
    Info,
    Warning,
    Error,
    Critical,
}

/// 事件
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Event {
    pub id: String,
    pub event_type: EventType,
    pub severity: EventSeverity,
    pub source_id: String,
    pub message: String,
    pub data: HashMap<String, serde_json::Value>,
    pub timestamp: DateTime<Utc>,
    pub acknowledged: bool,
    pub acknowledged_by: Option<String>,
    pub acknowledged_at: Option<DateTime<Utc>>,
}
```

### 4. 命令模型

```rust
/// 命令类型枚举
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum CommandType {
    Read,
    Write,
    Execute,
    Configure,
    Reset,
    Custom(String),
}

/// 命令状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum CommandStatus {
    Pending,
    Executing,
    Completed,
    Failed,
    Cancelled,
}

/// 命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Command {
    pub id: String,
    pub device_id: String,
    pub command_type: CommandType,
    pub parameters: HashMap<String, serde_json::Value>,
    pub status: CommandStatus,
    pub created_at: DateTime<Utc>,
    pub executed_at: Option<DateTime<Utc>>,
    pub completed_at: Option<DateTime<Utc>>,
    pub result: Option<serde_json::Value>,
    pub error_message: Option<String>,
}
```

## 数据模型管理器

```rust
use tokio::sync::RwLock;
use std::sync::Arc;
use uuid::Uuid;

/// 数据模型管理器
pub struct DataModelManager {
    devices: Arc<RwLock<HashMap<String, Device>>>,
    sensors: Arc<RwLock<HashMap<String, SensorConfig>>>,
    sensor_data: Arc<RwLock<HashMap<String, Vec<SensorData>>>>,
    events: Arc<RwLock<HashMap<String, Event>>>,
    commands: Arc<RwLock<HashMap<String, Command>>>,
}

impl DataModelManager {
    pub fn new() -> Self {
        Self {
            devices: Arc::new(RwLock::new(HashMap::new())),
            sensors: Arc::new(RwLock::new(HashMap::new())),
            sensor_data: Arc::new(RwLock::new(HashMap::new())),
            events: Arc::new(RwLock::new(HashMap::new())),
            commands: Arc::new(RwLock::new(HashMap::new())),
        }
    }

    /// 注册设备
    pub async fn register_device(&self, device: Device) -> Result<(), Box<dyn std::error::Error>> {
        let mut devices = self.devices.write().await;
        devices.insert(device.id.clone(), device);
        Ok(())
    }

    /// 获取设备
    pub async fn get_device(&self, device_id: &str) -> Option<Device> {
        let devices = self.devices.read().await;
        devices.get(device_id).cloned()
    }

    /// 更新设备状态
    pub async fn update_device_status(&self, device_id: &str, status: DeviceStatus) -> Result<(), Box<dyn std::error::Error>> {
        let mut devices = self.devices.write().await;
        if let Some(device) = devices.get_mut(device_id) {
            device.status = status;
            device.updated_at = Utc::now();
        }
        Ok(())
    }

    /// 添加传感器数据
    pub async fn add_sensor_data(&self, data: SensorData) -> Result<(), Box<dyn std::error::Error>> {
        let mut sensor_data = self.sensor_data.write().await;
        let device_data = sensor_data.entry(data.device_id.clone()).or_insert_with(Vec::new);
        device_data.push(data);
        Ok(())
    }

    /// 获取传感器数据
    pub async fn get_sensor_data(&self, device_id: &str, limit: Option<usize>) -> Vec<SensorData> {
        let sensor_data = self.sensor_data.read().await;
        if let Some(data) = sensor_data.get(device_id) {
            if let Some(limit) = limit {
                data.iter().rev().take(limit).cloned().collect()
            } else {
                data.clone()
            }
        } else {
            Vec::new()
        }
    }

    /// 创建事件
    pub async fn create_event(&self, event: Event) -> Result<(), Box<dyn std::error::Error>> {
        let mut events = self.events.write().await;
        events.insert(event.id.clone(), event);
        Ok(())
    }

    /// 获取事件
    pub async fn get_events(&self, source_id: Option<&str>, limit: Option<usize>) -> Vec<Event> {
        let events = self.events.read().await;
        let mut filtered_events: Vec<Event> = events.values()
            .filter(|event| {
                if let Some(source) = source_id {
                    event.source_id == source
                } else {
                    true
                }
            })
            .cloned()
            .collect();
        
        filtered_events.sort_by(|a, b| b.timestamp.cmp(&a.timestamp));
        
        if let Some(limit) = limit {
            filtered_events.truncate(limit);
        }
        
        filtered_events
    }

    /// 创建命令
    pub async fn create_command(&self, command: Command) -> Result<(), Box<dyn std::error::Error>> {
        let mut commands = self.commands.write().await;
        commands.insert(command.id.clone(), command);
        Ok(())
    }

    /// 更新命令状态
    pub async fn update_command_status(&self, command_id: &str, status: CommandStatus, result: Option<serde_json::Value>) -> Result<(), Box<dyn std::error::Error>> {
        let mut commands = self.commands.write().await;
        if let Some(command) = commands.get_mut(command_id) {
            command.status = status;
            command.result = result;
            match status {
                CommandStatus::Executing => command.executed_at = Some(Utc::now()),
                CommandStatus::Completed | CommandStatus::Failed => command.completed_at = Some(Utc::now()),
                _ => {}
            }
        }
        Ok(())
    }
}
```

## Go实现

### 1. 设备模型

```go
package models

import (
    "encoding/json"
    "time"
)

// DeviceType 设备类型
type DeviceType string

const (
    DeviceTypeSensor    DeviceType = "sensor"
    DeviceTypeActuator  DeviceType = "actuator"
    DeviceTypeGateway   DeviceType = "gateway"
    DeviceTypeController DeviceType = "controller"
    DeviceTypeCamera    DeviceType = "camera"
)

// DeviceStatus 设备状态
type DeviceStatus string

const (
    DeviceStatusOnline     DeviceStatus = "online"
    DeviceStatusOffline    DeviceStatus = "offline"
    DeviceStatusError      DeviceStatus = "error"
    DeviceStatusMaintenance DeviceStatus = "maintenance"
    DeviceStatusDisabled   DeviceStatus = "disabled"
)

// Location 设备位置
type Location struct {
    Latitude  float64 `json:"latitude"`
    Longitude float64 `json:"longitude"`
    Altitude  *float64 `json:"altitude,omitempty"`
    Address   *string  `json:"address,omitempty"`
}

// DeviceCapability 设备能力
type DeviceCapability struct {
    Name       string                 `json:"name"`
    Version    string                 `json:"version"`
    Parameters map[string]interface{} `json:"parameters"`
}

// Device 设备信息
type Device struct {
    ID          string                 `json:"id"`
    Name        string                 `json:"name"`
    DeviceType  DeviceType            `json:"device_type"`
    Status      DeviceStatus          `json:"status"`
    Location    *Location             `json:"location,omitempty"`
    Capabilities []DeviceCapability   `json:"capabilities"`
    Metadata    map[string]interface{} `json:"metadata"`
    CreatedAt   time.Time             `json:"created_at"`
    UpdatedAt   time.Time             `json:"updated_at"`
    LastSeen    *time.Time            `json:"last_seen,omitempty"`
}
```

### 2. 传感器数据模型

```go
// SensorType 传感器类型
type SensorType string

const (
    SensorTypeTemperature SensorType = "temperature"
    SensorTypeHumidity    SensorType = "humidity"
    SensorTypePressure    SensorType = "pressure"
    SensorTypeLight       SensorType = "light"
    SensorTypeMotion      SensorType = "motion"
    SensorTypeVoltage     SensorType = "voltage"
    SensorTypeCurrent     SensorType = "current"
    SensorTypePower       SensorType = "power"
)

// Unit 数据单位
type Unit string

const (
    UnitCelsius    Unit = "celsius"
    UnitFahrenheit Unit = "fahrenheit"
    UnitKelvin     Unit = "kelvin"
    UnitPercent    Unit = "percent"
    UnitPascal     Unit = "pascal"
    UnitLux        Unit = "lux"
    UnitVolt       Unit = "volt"
    UnitAmpere     Unit = "ampere"
    UnitWatt       Unit = "watt"
)

// DataQuality 数据质量
type DataQuality string

const (
    DataQualityGood     DataQuality = "good"
    DataQualityUncertain DataQuality = "uncertain"
    DataQualityBad      DataQuality = "bad"
    DataQualityInvalid  DataQuality = "invalid"
)

// SensorData 传感器数据
type SensorData struct {
    ID         string                 `json:"id"`
    DeviceID   string                 `json:"device_id"`
    SensorType SensorType            `json:"sensor_type"`
    Value      float64               `json:"value"`
    Unit       Unit                  `json:"unit"`
    Quality    DataQuality           `json:"quality"`
    Timestamp  time.Time             `json:"timestamp"`
    Metadata   map[string]interface{} `json:"metadata"`
}

// SensorConfig 传感器配置
type SensorConfig struct {
    SensorID        string                 `json:"sensor_id"`
    Name            string                 `json:"name"`
    SensorType      SensorType            `json:"sensor_type"`
    Unit            Unit                  `json:"unit"`
    SamplingRate    float64               `json:"sampling_rate"`
    RangeMin        *float64              `json:"range_min,omitempty"`
    RangeMax        *float64              `json:"range_max,omitempty"`
    Accuracy        *float64              `json:"accuracy,omitempty"`
    CalibrationData map[string]float64    `json:"calibration_data"`
}
```

### 3. 事件和命令模型

```go
// EventType 事件类型
type EventType string

const (
    EventTypeDeviceOnline  EventType = "device_online"
    EventTypeDeviceOffline EventType = "device_offline"
    EventTypeDataReceived  EventType = "data_received"
    EventTypeAlert         EventType = "alert"
    EventTypeError         EventType = "error"
    EventTypeMaintenance   EventType = "maintenance"
)

// EventSeverity 事件严重程度
type EventSeverity string

const (
    EventSeverityInfo     EventSeverity = "info"
    EventSeverityWarning  EventSeverity = "warning"
    EventSeverityError    EventSeverity = "error"
    EventSeverityCritical EventSeverity = "critical"
)

// Event 事件
type Event struct {
    ID             string                 `json:"id"`
    EventType      EventType             `json:"event_type"`
    Severity       EventSeverity         `json:"severity"`
    SourceID       string                 `json:"source_id"`
    Message        string                 `json:"message"`
    Data           map[string]interface{} `json:"data"`
    Timestamp      time.Time             `json:"timestamp"`
    Acknowledged   bool                  `json:"acknowledged"`
    AcknowledgedBy *string               `json:"acknowledged_by,omitempty"`
    AcknowledgedAt *time.Time            `json:"acknowledged_at,omitempty"`
}

// CommandType 命令类型
type CommandType string

const (
    CommandTypeRead      CommandType = "read"
    CommandTypeWrite     CommandType = "write"
    CommandTypeExecute   CommandType = "execute"
    CommandTypeConfigure CommandType = "configure"
    CommandTypeReset     CommandType = "reset"
)

// CommandStatus 命令状态
type CommandStatus string

const (
    CommandStatusPending   CommandStatus = "pending"
    CommandStatusExecuting CommandStatus = "executing"
    CommandStatusCompleted CommandStatus = "completed"
    CommandStatusFailed    CommandStatus = "failed"
    CommandStatusCancelled CommandStatus = "cancelled"
)

// Command 命令
type Command struct {
    ID            string                 `json:"id"`
    DeviceID      string                 `json:"device_id"`
    CommandType   CommandType           `json:"command_type"`
    Parameters    map[string]interface{} `json:"parameters"`
    Status        CommandStatus         `json:"status"`
    CreatedAt     time.Time             `json:"created_at"`
    ExecutedAt    *time.Time            `json:"executed_at,omitempty"`
    CompletedAt   *time.Time            `json:"completed_at,omitempty"`
    Result        interface{}           `json:"result,omitempty"`
    ErrorMessage  *string               `json:"error_message,omitempty"`
}
```

### 4. 数据模型管理器

```go
import (
    "fmt"
    "sync"
    "time"
)

// DataModelManager 数据模型管理器
type DataModelManager struct {
    devices     map[string]Device
    sensors     map[string]SensorConfig
    sensorData  map[string][]SensorData
    events      map[string]Event
    commands    map[string]Command
    mu          sync.RWMutex
}

// NewDataModelManager 创建数据模型管理器
func NewDataModelManager() *DataModelManager {
    return &DataModelManager{
        devices:    make(map[string]Device),
        sensors:    make(map[string]SensorConfig),
        sensorData: make(map[string][]SensorData),
        events:     make(map[string]Event),
        commands:   make(map[string]Command),
    }
}

// RegisterDevice 注册设备
func (m *DataModelManager) RegisterDevice(device Device) error {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    m.devices[device.ID] = device
    return nil
}

// GetDevice 获取设备
func (m *DataModelManager) GetDevice(deviceID string) (Device, bool) {
    m.mu.RLock()
    defer m.mu.RUnlock()
    
    device, exists := m.devices[deviceID]
    return device, exists
}

// UpdateDeviceStatus 更新设备状态
func (m *DataModelManager) UpdateDeviceStatus(deviceID string, status DeviceStatus) error {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    if device, exists := m.devices[deviceID]; exists {
        device.Status = status
        device.UpdatedAt = time.Now()
        m.devices[deviceID] = device
        return nil
    }
    return fmt.Errorf("device not found: %s", deviceID)
}

// AddSensorData 添加传感器数据
func (m *DataModelManager) AddSensorData(data SensorData) error {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    m.sensorData[data.DeviceID] = append(m.sensorData[data.DeviceID], data)
    return nil
}

// GetSensorData 获取传感器数据
func (m *DataModelManager) GetSensorData(deviceID string, limit *int) []SensorData {
    m.mu.RLock()
    defer m.mu.RUnlock()
    
    data, exists := m.sensorData[deviceID]
    if !exists {
        return []SensorData{}
    }
    
    if limit != nil && *limit < len(data) {
        return data[len(data)-*limit:]
    }
    return data
}

// CreateEvent 创建事件
func (m *DataModelManager) CreateEvent(event Event) error {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    m.events[event.ID] = event
    return nil
}

// GetEvents 获取事件
func (m *DataModelManager) GetEvents(sourceID *string, limit *int) []Event {
    m.mu.RLock()
    defer m.mu.RUnlock()
    
    var events []Event
    for _, event := range m.events {
        if sourceID == nil || event.SourceID == *sourceID {
            events = append(events, event)
        }
    }
    
    // 按时间倒序排序
    for i := 0; i < len(events)-1; i++ {
        for j := i + 1; j < len(events); j++ {
            if events[i].Timestamp.Before(events[j].Timestamp) {
                events[i], events[j] = events[j], events[i]
            }
        }
    }
    
    if limit != nil && *limit < len(events) {
        events = events[:*limit]
    }
    
    return events
}
```

## 使用示例

### Rust示例

```rust
#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 创建数据模型管理器
    let manager = DataModelManager::new();
    
    // 创建设备
    let device = Device {
        id: "sensor_001".to_string(),
        name: "Temperature Sensor".to_string(),
        device_type: DeviceType::Sensor,
        status: DeviceStatus::Online,
        location: Some(Location {
            latitude: 39.9042,
            longitude: 116.4074,
            altitude: Some(44.0),
            address: Some("Beijing, China".to_string()),
        }),
        capabilities: vec![
            DeviceCapability {
                name: "temperature_reading".to_string(),
                version: "1.0".to_string(),
                parameters: HashMap::new(),
            }
        ],
        metadata: HashMap::new(),
        created_at: Utc::now(),
        updated_at: Utc::now(),
        last_seen: Some(Utc::now()),
    };
    
    // 注册设备
    manager.register_device(device).await?;
    
    // 添加传感器数据
    let sensor_data = SensorData {
        id: Uuid::new_v4().to_string(),
        device_id: "sensor_001".to_string(),
        sensor_type: SensorType::Temperature,
        value: 25.5,
        unit: Unit::Celsius,
        quality: DataQuality::Good,
        timestamp: Utc::now(),
        metadata: HashMap::new(),
    };
    
    manager.add_sensor_data(sensor_data).await?;
    
    // 创建事件
    let event = Event {
        id: Uuid::new_v4().to_string(),
        event_type: EventType::DataReceived,
        severity: EventSeverity::Info,
        source_id: "sensor_001".to_string(),
        message: "Temperature data received".to_string(),
        data: HashMap::new(),
        timestamp: Utc::now(),
        acknowledged: false,
        acknowledged_by: None,
        acknowledged_at: None,
    };
    
    manager.create_event(event).await?;
    
    println!("数据模型管理器初始化完成");
    Ok(())
}
```

### Go示例

```go
func main() {
    // 创建数据模型管理器
    manager := NewDataModelManager()
    
    // 创建设备
    device := Device{
        ID:         "sensor_001",
        Name:       "Temperature Sensor",
        DeviceType: DeviceTypeSensor,
        Status:     DeviceStatusOnline,
        Location: &Location{
            Latitude:  39.9042,
            Longitude: 116.4074,
            Altitude:  float64Ptr(44.0),
            Address:   stringPtr("Beijing, China"),
        },
        Capabilities: []DeviceCapability{
            {
                Name:       "temperature_reading",
                Version:    "1.0",
                Parameters: make(map[string]interface{}),
            },
        },
        Metadata:  make(map[string]interface{}),
        CreatedAt: time.Now(),
        UpdatedAt: time.Now(),
        LastSeen:  timePtr(time.Now()),
    }
    
    // 注册设备
    manager.RegisterDevice(device)
    
    // 添加传感器数据
    sensorData := SensorData{
        ID:         "data_001",
        DeviceID:   "sensor_001",
        SensorType: SensorTypeTemperature,
        Value:      25.5,
        Unit:       UnitCelsius,
        Quality:    DataQualityGood,
        Timestamp:  time.Now(),
        Metadata:   make(map[string]interface{}),
    }
    
    manager.AddSensorData(sensorData)
    
    // 创建事件
    event := Event{
        ID:           "event_001",
        EventType:    EventTypeDataReceived,
        Severity:     EventSeverityInfo,
        SourceID:     "sensor_001",
        Message:      "Temperature data received",
        Data:         make(map[string]interface{}),
        Timestamp:    time.Now(),
        Acknowledged: false,
    }
    
    manager.CreateEvent(event)
    
    fmt.Println("数据模型管理器初始化完成")
}

func float64Ptr(v float64) *float64 {
    return &v
}

func stringPtr(v string) *string {
    return &v
}

func timePtr(v time.Time) *time.Time {
    return &v
}
```

## 总结

统一数据模型提供了：

1. **标准化数据结构**：定义了设备、传感器、事件、命令等核心实体
2. **类型安全**：使用枚举和强类型确保数据一致性
3. **扩展性**：支持自定义类型和元数据
4. **时间管理**：统一的时间戳和状态跟踪
5. **数据质量**：支持数据质量评估和验证
6. **跨语言支持**：Rust和Go双语言实现

这个实现为IoT系统提供了统一、标准化的数据模型基础，确保不同组件之间的数据互操作性。
