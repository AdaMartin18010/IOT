# 设备管理实现

## 概述

设备管理系统负责IoT设备的全生命周期管理，包括设备注册、状态监控、配置管理和数据收集。

## 核心组件

### 1. 设备管理器

#### Rust实现

```rust
use std::collections::HashMap;
use std::sync::{Arc, RwLock};
use tokio::sync::mpsc;
use serde::{Deserialize, Serialize};
use chrono::{DateTime, Utc};

/// 设备状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum DeviceStatus {
    Online,
    Offline,
    Maintenance,
    Error(String),
}

/// 设备类型
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum DeviceType {
    Sensor,
    Actuator,
    Gateway,
    Controller,
    Camera,
    Custom(String),
}

/// 设备信息
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceInfo {
    pub id: String,
    pub name: String,
    pub device_type: DeviceType,
    pub status: DeviceStatus,
    pub location: Option<Location>,
    pub capabilities: Vec<DeviceCapability>,
    pub metadata: HashMap<String, serde_json::Value>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub last_seen: Option<DateTime<Utc>>,
}

/// 位置信息
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Location {
    pub latitude: f64,
    pub longitude: f64,
    pub altitude: Option<f64>,
    pub description: Option<String>,
}

/// 设备能力
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceCapability {
    pub name: String,
    pub description: String,
    pub data_type: String,
    pub unit: Option<String>,
    pub range: Option<(f64, f64)>,
}

/// 设备管理器
pub struct DeviceManager {
    devices: Arc<RwLock<HashMap<String, DeviceInfo>>>,
    device_types: Arc<RwLock<HashMap<String, DeviceTypeInfo>>>,
    event_sender: mpsc::Sender<DeviceEvent>,
    health_check_interval: std::time::Duration,
}

impl DeviceManager {
    pub fn new(health_check_interval: std::time::Duration) -> Self {
        let (event_sender, _) = mpsc::channel(1000);
        
        Self {
            devices: Arc::new(RwLock::new(HashMap::new())),
            device_types: Arc::new(RwLock::new(HashMap::new())),
            event_sender,
            health_check_interval,
        }
    }

    /// 注册设备
    pub async fn register_device(&self, device_info: DeviceInfo) -> Result<String, Box<dyn std::error::Error>> {
        let device_id = device_info.id.clone();
        
        {
            let mut devices = self.devices.write().unwrap();
            devices.insert(device_id.clone(), device_info);
        }

        // 发送注册事件
        let _ = self.event_sender.send(DeviceEvent::DeviceRegistered { 
            device_id: device_id.clone() 
        }).await;

        Ok(device_id)
    }

    /// 更新设备状态
    pub async fn update_device_status(&self, device_id: &str, status: DeviceStatus) -> Result<(), Box<dyn std::error::Error>> {
        {
            let mut devices = self.devices.write().unwrap();
            if let Some(device) = devices.get_mut(device_id) {
                device.status = status.clone();
                device.updated_at = Utc::now();
            }
        }

        // 发送状态更新事件
        let _ = self.event_sender.send(DeviceEvent::DeviceStatusChanged { 
            device_id: device_id.to_string(),
            status 
        }).await;

        Ok(())
    }

    /// 获取设备信息
    pub fn get_device(&self, device_id: &str) -> Option<DeviceInfo> {
        let devices = self.devices.read().unwrap();
        devices.get(device_id).cloned()
    }

    /// 获取所有设备
    pub fn get_all_devices(&self) -> Vec<DeviceInfo> {
        let devices = self.devices.read().unwrap();
        devices.values().cloned().collect()
    }

    /// 按类型获取设备
    pub fn get_devices_by_type(&self, device_type: DeviceType) -> Vec<DeviceInfo> {
        let devices = self.devices.read().unwrap();
        devices
            .values()
            .filter(|device| std::mem::discriminant(&device.device_type) == std::mem::discriminant(&device_type))
            .cloned()
            .collect()
    }

    /// 移除设备
    pub async fn remove_device(&self, device_id: &str) -> Result<(), Box<dyn std::error::Error>> {
        {
            let mut devices = self.devices.write().unwrap();
            devices.remove(device_id);
        }

        // 发送移除事件
        let _ = self.event_sender.send(DeviceEvent::DeviceRemoved { 
            device_id: device_id.to_string() 
        }).await;

        Ok(())
    }

    /// 健康检查
    pub async fn health_check(&self) -> HashMap<String, DeviceHealth> {
        let mut health_status = HashMap::new();
        let devices = {
            let devices = self.devices.read().unwrap();
            devices.clone()
        };

        for (device_id, device) in devices {
            let is_online = matches!(device.status, DeviceStatus::Online);
            let last_seen = device.last_seen.unwrap_or(device.updated_at);
            let time_since_last_seen = Utc::now() - last_seen;

            health_status.insert(device_id, DeviceHealth {
                is_healthy: is_online && time_since_last_seen.num_seconds() < 300, // 5分钟
                last_seen,
                status: device.status,
            });
        }

        health_status
    }
}

/// 设备事件
#[derive(Debug, Clone)]
pub enum DeviceEvent {
    DeviceRegistered { device_id: String },
    DeviceStatusChanged { device_id: String, status: DeviceStatus },
    DeviceRemoved { device_id: String },
    DeviceDataReceived { device_id: String, data: serde_json::Value },
}

/// 设备健康状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceHealth {
    pub is_healthy: bool,
    pub last_seen: DateTime<Utc>,
    pub status: DeviceStatus,
}

/// 设备类型信息
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceTypeInfo {
    pub name: String,
    pub description: String,
    pub capabilities: Vec<DeviceCapability>,
    pub protocols: Vec<String>,
}
```

#### Go实现

```go
package device

import (
    "sync"
    "time"
    "encoding/json"
)

// DeviceStatus 设备状态
type DeviceStatus string

const (
    DeviceStatusOnline      DeviceStatus = "online"
    DeviceStatusOffline     DeviceStatus = "offline"
    DeviceStatusMaintenance DeviceStatus = "maintenance"
    DeviceStatusError       DeviceStatus = "error"
)

// DeviceType 设备类型
type DeviceType string

const (
    DeviceTypeSensor    DeviceType = "sensor"
    DeviceTypeActuator  DeviceType = "actuator"
    DeviceTypeGateway   DeviceType = "gateway"
    DeviceTypeController DeviceType = "controller"
    DeviceTypeCamera    DeviceType = "camera"
    DeviceTypeCustom    DeviceType = "custom"
)

// DeviceInfo 设备信息
type DeviceInfo struct {
    ID          string                 `json:"id"`
    Name        string                 `json:"name"`
    DeviceType  DeviceType            `json:"device_type"`
    Status      DeviceStatus          `json:"status"`
    Location    *Location             `json:"location,omitempty"`
    Capabilities []DeviceCapability   `json:"capabilities"`
    Metadata    map[string]interface{} `json:"metadata"`
    CreatedAt   time.Time             `json:"created_at"`
    UpdatedAt   time.Time             `json:"updated_at"`
    LastSeen    *time.Time            `json:"last_seen,omitempty"`
}

// Location 位置信息
type Location struct {
    Latitude    float64 `json:"latitude"`
    Longitude   float64 `json:"longitude"`
    Altitude    *float64 `json:"altitude,omitempty"`
    Description *string  `json:"description,omitempty"`
}

// DeviceCapability 设备能力
type DeviceCapability struct {
    Name        string   `json:"name"`
    Description string   `json:"description"`
    DataType    string   `json:"data_type"`
    Unit        *string  `json:"unit,omitempty"`
    Range       *Range   `json:"range,omitempty"`
}

// Range 数值范围
type Range struct {
    Min float64 `json:"min"`
    Max float64 `json:"max"`
}

// DeviceManager 设备管理器
type DeviceManager struct {
    devices              map[string]DeviceInfo
    deviceTypes          map[string]DeviceTypeInfo
    eventChan            chan DeviceEvent
    healthCheckInterval  time.Duration
    mu                   sync.RWMutex
}

// NewDeviceManager 创建设备管理器
func NewDeviceManager(healthCheckInterval time.Duration) *DeviceManager {
    return &DeviceManager{
        devices:             make(map[string]DeviceInfo),
        deviceTypes:         make(map[string]DeviceTypeInfo),
        eventChan:           make(chan DeviceEvent, 1000),
        healthCheckInterval: healthCheckInterval,
    }
}

// RegisterDevice 注册设备
func (dm *DeviceManager) RegisterDevice(deviceInfo DeviceInfo) error {
    dm.mu.Lock()
    defer dm.mu.Unlock()

    deviceInfo.CreatedAt = time.Now()
    deviceInfo.UpdatedAt = time.Now()
    dm.devices[deviceInfo.ID] = deviceInfo

    // 发送注册事件
    select {
    case dm.eventChan <- DeviceEvent{Type: EventTypeDeviceRegistered, DeviceID: deviceInfo.ID}:
    default:
    }

    return nil
}

// UpdateDeviceStatus 更新设备状态
func (dm *DeviceManager) UpdateDeviceStatus(deviceID string, status DeviceStatus) error {
    dm.mu.Lock()
    defer dm.mu.Unlock()

    if device, exists := dm.devices[deviceID]; exists {
        device.Status = status
        device.UpdatedAt = time.Now()
        dm.devices[deviceID] = device

        // 发送状态更新事件
        select {
        case dm.eventChan <- DeviceEvent{Type: EventTypeDeviceStatusChanged, DeviceID: deviceID, Status: status}:
        default:
        }
    }

    return nil
}

// GetDevice 获取设备信息
func (dm *DeviceManager) GetDevice(deviceID string) (DeviceInfo, bool) {
    dm.mu.RLock()
    defer dm.mu.RUnlock()
    
    device, exists := dm.devices[deviceID]
    return device, exists
}

// GetAllDevices 获取所有设备
func (dm *DeviceManager) GetAllDevices() []DeviceInfo {
    dm.mu.RLock()
    defer dm.mu.RUnlock()
    
    devices := make([]DeviceInfo, 0, len(dm.devices))
    for _, device := range dm.devices {
        devices = append(devices, device)
    }
    return devices
}

// GetDevicesByType 按类型获取设备
func (dm *DeviceManager) GetDevicesByType(deviceType DeviceType) []DeviceInfo {
    dm.mu.RLock()
    defer dm.mu.RUnlock()
    
    var devices []DeviceInfo
    for _, device := range dm.devices {
        if device.DeviceType == deviceType {
            devices = append(devices, device)
        }
    }
    return devices
}

// RemoveDevice 移除设备
func (dm *DeviceManager) RemoveDevice(deviceID string) error {
    dm.mu.Lock()
    defer dm.mu.Unlock()

    delete(dm.devices, deviceID)

    // 发送移除事件
    select {
    case dm.eventChan <- DeviceEvent{Type: EventTypeDeviceRemoved, DeviceID: deviceID}:
    default:
    }

    return nil
}

// HealthCheck 健康检查
func (dm *DeviceManager) HealthCheck() map[string]DeviceHealth {
    dm.mu.RLock()
    devices := make(map[string]DeviceInfo)
    for id, device := range dm.devices {
        devices[id] = device
    }
    dm.mu.RUnlock()

    healthStatus := make(map[string]DeviceHealth)
    for deviceID, device := range devices {
        isOnline := device.Status == DeviceStatusOnline
        lastSeen := device.UpdatedAt
        if device.LastSeen != nil {
            lastSeen = *device.LastSeen
        }
        
        timeSinceLastSeen := time.Since(lastSeen)
        isHealthy := isOnline && timeSinceLastSeen < 5*time.Minute

        healthStatus[deviceID] = DeviceHealth{
            IsHealthy: isHealthy,
            LastSeen:  lastSeen,
            Status:    device.Status,
        }
    }

    return healthStatus
}

// GetEventChannel 获取事件通道
func (dm *DeviceManager) GetEventChannel() <-chan DeviceEvent {
    return dm.eventChan
}

// DeviceEvent 设备事件
type DeviceEvent struct {
    Type     EventType     `json:"type"`
    DeviceID string        `json:"device_id"`
    Status   DeviceStatus  `json:"status,omitempty"`
    Data     interface{}   `json:"data,omitempty"`
}

// EventType 事件类型
type EventType string

const (
    EventTypeDeviceRegistered    EventType = "device_registered"
    EventTypeDeviceStatusChanged EventType = "device_status_changed"
    EventTypeDeviceRemoved       EventType = "device_removed"
    EventTypeDeviceDataReceived  EventType = "device_data_received"
)

// DeviceHealth 设备健康状态
type DeviceHealth struct {
    IsHealthy bool         `json:"is_healthy"`
    LastSeen  time.Time    `json:"last_seen"`
    Status    DeviceStatus `json:"status"`
}

// DeviceTypeInfo 设备类型信息
type DeviceTypeInfo struct {
    Name         string             `json:"name"`
    Description  string             `json:"description"`
    Capabilities []DeviceCapability `json:"capabilities"`
    Protocols    []string           `json:"protocols"`
}
```

### 2. 使用示例

```rust
// Rust示例
#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let device_manager = Arc::new(DeviceManager::new(
        std::time::Duration::from_secs(30)
    ));

    // 注册温度传感器
    let temp_sensor = DeviceInfo {
        id: "temp-sensor-001".to_string(),
        name: "Temperature Sensor 1".to_string(),
        device_type: DeviceType::Sensor,
        status: DeviceStatus::Online,
        location: Some(Location {
            latitude: 39.9042,
            longitude: 116.4074,
            altitude: Some(44.0),
            description: Some("Building A, Floor 3".to_string()),
        }),
        capabilities: vec![
            DeviceCapability {
                name: "temperature".to_string(),
                description: "Temperature measurement".to_string(),
                data_type: "float".to_string(),
                unit: Some("°C".to_string()),
                range: Some((-40.0, 85.0)),
            }
        ],
        metadata: HashMap::new(),
        created_at: Utc::now(),
        updated_at: Utc::now(),
        last_seen: Some(Utc::now()),
    };

    device_manager.register_device(temp_sensor).await?;

    // 获取设备信息
    let devices = device_manager.get_all_devices();
    println!("Registered devices: {}", devices.len());

    // 健康检查
    let health = device_manager.health_check().await;
    println!("Health status: {:?}", health);

    Ok(())
}
```

```go
// Go示例
func main() {
    deviceManager := NewDeviceManager(30 * time.Second)

    // 注册温度传感器
    tempSensor := DeviceInfo{
        ID:         "temp-sensor-001",
        Name:       "Temperature Sensor 1",
        DeviceType: DeviceTypeSensor,
        Status:     DeviceStatusOnline,
        Location: &Location{
            Latitude:    39.9042,
            Longitude:   116.4074,
            Altitude:    float64Ptr(44.0),
            Description: stringPtr("Building A, Floor 3"),
        },
        Capabilities: []DeviceCapability{
            {
                Name:        "temperature",
                Description: "Temperature measurement",
                DataType:    "float",
                Unit:        stringPtr("°C"),
                Range: &Range{
                    Min: -40.0,
                    Max: 85.0,
                },
            },
        },
        Metadata:  make(map[string]interface{}),
        CreatedAt: time.Now(),
        UpdatedAt: time.Now(),
        LastSeen:  timePtr(time.Now()),
    }

    deviceManager.RegisterDevice(tempSensor)

    // 获取设备信息
    devices := deviceManager.GetAllDevices()
    fmt.Printf("Registered devices: %d\n", len(devices))

    // 健康检查
    health := deviceManager.HealthCheck()
    fmt.Printf("Health status: %+v\n", health)

    // 监听事件
    go func() {
        for event := range deviceManager.GetEventChannel() {
            fmt.Printf("Device event: %+v\n", event)
        }
    }()

    select {}
}

func float64Ptr(v float64) *float64 { return &v }
func stringPtr(v string) *string { return &v }
func timePtr(v time.Time) *time.Time { return &v }
```

## 总结

设备管理系统提供了以下核心功能：

1. **设备注册管理**：支持设备的注册、更新和移除
2. **状态监控**：实时跟踪设备状态和健康信息
3. **类型管理**：按设备类型组织和访问设备
4. **位置管理**：支持设备地理位置信息
5. **能力描述**：定义设备的功能和能力
6. **事件系统**：提供设备状态变化的事件通知
7. **健康检查**：定期检查设备健康状态

这个实现为IoT平台提供了完整的设备生命周期管理能力。
