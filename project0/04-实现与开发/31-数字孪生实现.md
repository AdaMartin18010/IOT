# 数字孪生实现

## 概述

数字孪生是IoT平台的核心功能，通过实时数据同步和虚拟模型来模拟物理设备的状态和行为。

## 核心架构

### 1. 数字孪生定义

```rust
// 数字孪生核心结构
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DigitalTwin {
    pub id: String,
    pub name: String,
    pub device_id: String,
    pub twin_type: TwinType,
    pub properties: HashMap<String, TwinProperty>,
    pub relationships: Vec<TwinRelationship>,
    pub state: TwinState,
    pub metadata: TwinMetadata,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum TwinType {
    Device,
    System,
    Process,
    Environment,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TwinProperty {
    pub name: String,
    pub value: TwinValue,
    pub data_type: DataType,
    pub unit: Option<String>,
    pub description: Option<String>,
    pub writable: bool,
    pub last_updated: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum TwinValue {
    String(String),
    Number(f64),
    Boolean(bool),
    Array(Vec<TwinValue>),
    Object(HashMap<String, TwinValue>),
    Null,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TwinRelationship {
    pub id: String,
    pub name: String,
    pub target_twin_id: String,
    pub relationship_type: RelationshipType,
    pub properties: HashMap<String, TwinValue>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum RelationshipType {
    Contains,
    DependsOn,
    Controls,
    Monitors,
    InteractsWith,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TwinState {
    pub status: TwinStatus,
    pub health_score: f64,
    pub last_heartbeat: DateTime<Utc>,
    pub error_count: u32,
    pub warning_count: u32,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum TwinStatus {
    Online,
    Offline,
    Error,
    Warning,
    Maintenance,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TwinMetadata {
    pub version: String,
    pub model: String,
    pub manufacturer: String,
    pub location: Option<Location>,
    pub tags: Vec<String>,
}
```

### 2. 数字孪生管理器

```rust
pub struct DigitalTwinManager {
    twins: Arc<RwLock<HashMap<String, DigitalTwin>>>,
    event_sender: mpsc::Sender<TwinEvent>,
    data_sync_interval: Duration,
}

impl DigitalTwinManager {
    pub fn new() -> Self {
        let (event_sender, event_receiver) = mpsc::channel();
        
        Self {
            twins: Arc::new(RwLock::new(HashMap::new())),
            event_sender,
            data_sync_interval: Duration::from_secs(5),
        }
    }

    // 创建数字孪生
    pub async fn create_twin(&self, twin: DigitalTwin) -> Result<(), TwinError> {
        let mut twins = self.twins.write().await;
        twins.insert(twin.id.clone(), twin);
        
        self.event_sender.send(TwinEvent::Created(twin.id.clone())).await?;
        Ok(())
    }

    // 更新孪生属性
    pub async fn update_property(
        &self,
        twin_id: &str,
        property_name: &str,
        value: TwinValue,
    ) -> Result<(), TwinError> {
        let mut twins = self.twins.write().await;
        
        if let Some(twin) = twins.get_mut(twin_id) {
            if let Some(property) = twin.properties.get_mut(property_name) {
                property.value = value;
                property.last_updated = Utc::now();
                twin.updated_at = Utc::now();
                
                self.event_sender.send(TwinEvent::PropertyUpdated(
                    twin_id.to_string(),
                    property_name.to_string(),
                )).await?;
            }
        }
        
        Ok(())
    }

    // 获取孪生状态
    pub async fn get_twin(&self, twin_id: &str) -> Option<DigitalTwin> {
        let twins = self.twins.read().await;
        twins.get(twin_id).cloned()
    }

    // 同步物理设备数据
    pub async fn sync_device_data(&self, device_id: &str, data: DeviceData) -> Result<(), TwinError> {
        let twins = self.twins.read().await;
        
        for twin in twins.values() {
            if twin.device_id == device_id {
                // 更新孪生属性
                self.update_property(&twin.id, "temperature", TwinValue::Number(data.temperature)).await?;
                self.update_property(&twin.id, "humidity", TwinValue::Number(data.humidity)).await?;
                self.update_property(&twin.id, "status", TwinValue::String(data.status)).await?;
            }
        }
        
        Ok(())
    }
}
```

### 3. 数字孪生事件系统

```rust
#[derive(Debug, Clone)]
pub enum TwinEvent {
    Created(String),
    Updated(String),
    Deleted(String),
    PropertyUpdated(String, String),
    StateChanged(String, TwinStatus),
    RelationshipAdded(String, String),
    RelationshipRemoved(String, String),
}

pub struct TwinEventHandler {
    event_receiver: mpsc::Receiver<TwinEvent>,
    notification_sender: mpsc::Sender<Notification>,
}

impl TwinEventHandler {
    pub async fn handle_events(&mut self) {
        while let Some(event) = self.event_receiver.recv().await {
            match event {
                TwinEvent::Created(twin_id) => {
                    println!("数字孪生已创建: {}", twin_id);
                    self.notification_sender.send(Notification::TwinCreated(twin_id)).await.ok();
                }
                TwinEvent::PropertyUpdated(twin_id, property_name) => {
                    println!("孪生属性已更新: {} - {}", twin_id, property_name);
                    self.notification_sender.send(Notification::PropertyChanged(twin_id, property_name)).await.ok();
                }
                TwinEvent::StateChanged(twin_id, status) => {
                    println!("孪生状态已改变: {} - {:?}", twin_id, status);
                    self.notification_sender.send(Notification::StateChanged(twin_id, status)).await.ok();
                }
                _ => {}
            }
        }
    }
}
```

### 4. 数字孪生API

```rust
#[derive(Deserialize)]
pub struct CreateTwinRequest {
    pub name: String,
    pub device_id: String,
    pub twin_type: TwinType,
    pub properties: HashMap<String, TwinProperty>,
}

#[derive(Serialize)]
pub struct TwinResponse {
    pub twin: DigitalTwin,
    pub relationships: Vec<TwinRelationship>,
    pub state: TwinState,
}

// RESTful API路由
pub fn twin_routes() -> Router {
    Router::new()
        .route("/twins", post(create_twin))
        .route("/twins/:id", get(get_twin))
        .route("/twins/:id", put(update_twin))
        .route("/twins/:id", delete(delete_twin))
        .route("/twins/:id/properties", put(update_properties))
        .route("/twins/:id/relationships", post(add_relationship))
        .route("/twins/:id/sync", post(sync_twin))
}

async fn create_twin(
    Json(request): Json<CreateTwinRequest>,
    State(twin_manager): State<Arc<DigitalTwinManager>>,
) -> Result<Json<TwinResponse>, StatusCode> {
    let twin = DigitalTwin {
        id: Uuid::new_v4().to_string(),
        name: request.name,
        device_id: request.device_id,
        twin_type: request.twin_type,
        properties: request.properties,
        relationships: Vec::new(),
        state: TwinState {
            status: TwinStatus::Online,
            health_score: 100.0,
            last_heartbeat: Utc::now(),
            error_count: 0,
            warning_count: 0,
        },
        metadata: TwinMetadata {
            version: "1.0".to_string(),
            model: "default".to_string(),
            manufacturer: "unknown".to_string(),
            location: None,
            tags: Vec::new(),
        },
        created_at: Utc::now(),
        updated_at: Utc::now(),
    };

    twin_manager.create_twin(twin.clone()).await
        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;

    Ok(Json(TwinResponse {
        twin,
        relationships: Vec::new(),
        state: twin.state.clone(),
    }))
}

async fn get_twin(
    Path(twin_id): Path<String>,
    State(twin_manager): State<Arc<DigitalTwinManager>>,
) -> Result<Json<TwinResponse>, StatusCode> {
    let twin = twin_manager.get_twin(&twin_id).await
        .ok_or(StatusCode::NOT_FOUND)?;

    Ok(Json(TwinResponse {
        twin: twin.clone(),
        relationships: twin.relationships,
        state: twin.state,
    }))
}
```

## 使用示例

### 1. 创建设备数字孪生

```rust
#[tokio::main]
async fn main() {
    let twin_manager = Arc::new(DigitalTwinManager::new());
    
    // 创建传感器数字孪生
    let sensor_twin = DigitalTwin {
        id: "sensor-001".to_string(),
        name: "温度传感器".to_string(),
        device_id: "device-001".to_string(),
        twin_type: TwinType::Device,
        properties: HashMap::from([
            ("temperature".to_string(), TwinProperty {
                name: "temperature".to_string(),
                value: TwinValue::Number(25.5),
                data_type: DataType::Float,
                unit: Some("°C".to_string()),
                description: Some("当前温度".to_string()),
                writable: false,
                last_updated: Utc::now(),
            }),
            ("humidity".to_string(), TwinProperty {
                name: "humidity".to_string(),
                value: TwinValue::Number(60.0),
                data_type: DataType::Float,
                unit: Some("%".to_string()),
                description: Some("当前湿度".to_string()),
                writable: false,
                last_updated: Utc::now(),
            }),
        ]),
        relationships: Vec::new(),
        state: TwinState {
            status: TwinStatus::Online,
            health_score: 95.0,
            last_heartbeat: Utc::now(),
            error_count: 0,
            warning_count: 0,
        },
        metadata: TwinMetadata {
            version: "1.0".to_string(),
            model: "DHT22".to_string(),
            manufacturer: "Adafruit".to_string(),
            location: Some(Location {
                latitude: 39.9042,
                longitude: 116.4074,
                altitude: 50.0,
            }),
            tags: vec!["sensor".to_string(), "temperature".to_string(), "humidity".to_string()],
        },
        created_at: Utc::now(),
        updated_at: Utc::now(),
    };

    twin_manager.create_twin(sensor_twin).await.unwrap();
    println!("数字孪生创建成功");
}
```

### 2. 实时数据同步

```rust
// 模拟设备数据更新
async fn simulate_device_data(twin_manager: Arc<DigitalTwinManager>) {
    loop {
        let device_data = DeviceData {
            temperature: 20.0 + (rand::random::<f64>() * 10.0),
            humidity: 50.0 + (rand::random::<f64>() * 20.0),
            status: "normal".to_string(),
        };

        twin_manager.sync_device_data("device-001", device_data).await.unwrap();
        tokio::time::sleep(Duration::from_secs(5)).await;
    }
}
```

### 3. 数字孪生关系管理

```rust
// 添加孪生关系
async fn add_twin_relationship(twin_manager: &DigitalTwinManager) {
    let relationship = TwinRelationship {
        id: "rel-001".to_string(),
        name: "监控关系".to_string(),
        target_twin_id: "controller-001".to_string(),
        relationship_type: RelationshipType::Monitors,
        properties: HashMap::from([
            ("monitoring_interval".to_string(), TwinValue::Number(5.0)),
            ("alert_threshold".to_string(), TwinValue::Number(30.0)),
        ]),
    };

    // 添加到孪生关系列表
    let mut twins = twin_manager.twins.write().await;
    if let Some(twin) = twins.get_mut("sensor-001") {
        twin.relationships.push(relationship);
    }
}
```

## 核心特性

1. **实时同步**: 与物理设备保持实时数据同步
2. **状态管理**: 跟踪孪生状态和健康度
3. **关系建模**: 支持复杂的孪生间关系
4. **事件驱动**: 基于事件的更新和通知机制
5. **API接口**: 提供完整的RESTful API
6. **元数据管理**: 支持版本、位置、标签等元数据

这个数字孪生实现提供了完整的IoT设备虚拟化功能，支持实时数据同步、状态管理和关系建模。
