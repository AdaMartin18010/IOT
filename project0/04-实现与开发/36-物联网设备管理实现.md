# 物联网设备管理实现

## 概述

物联网设备管理系统提供设备注册、状态监控、固件管理、设备控制和生命周期管理功能。

## 核心架构

### 1. 设备管理核心

```rust
// 设备管理核心结构
pub struct DeviceManager {
    devices: Arc<RwLock<HashMap<String, Device>>>,
    device_types: Arc<RwLock<HashMap<String, DeviceType>>>,
    firmware_manager: Arc<FirmwareManager>,
    device_controller: Arc<DeviceController>,
    event_bus: Arc<EventBus>,
    cache: Arc<RedisCache>,
}

// 设备定义
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Device {
    pub id: String,
    pub name: String,
    pub device_type: String,
    pub status: DeviceStatus,
    pub location: Option<Location>,
    pub properties: HashMap<String, DeviceProperty>,
    pub capabilities: Vec<DeviceCapability>,
    pub firmware: FirmwareInfo,
    pub metadata: HashMap<String, String>,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub last_seen: Option<DateTime<Utc>>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum DeviceStatus {
    Online,
    Offline,
    Error,
    Maintenance,
    Disabled,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Location {
    pub latitude: f64,
    pub longitude: f64,
    pub altitude: Option<f64>,
    pub address: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceProperty {
    pub name: String,
    pub value: serde_json::Value,
    pub data_type: DataType,
    pub unit: Option<String>,
    pub description: Option<String>,
    pub writable: bool,
    pub last_updated: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceCapability {
    pub name: String,
    pub capability_type: CapabilityType,
    pub parameters: HashMap<String, serde_json::Value>,
    pub description: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum CapabilityType {
    Sensor,
    Actuator,
    Controller,
    Gateway,
    Custom(String),
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct FirmwareInfo {
    pub current_version: String,
    pub target_version: Option<String>,
    pub update_status: FirmwareUpdateStatus,
    pub last_update: Option<DateTime<Utc>>,
    pub checksum: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum FirmwareUpdateStatus {
    UpToDate,
    UpdateAvailable,
    Updating,
    UpdateFailed,
    UpdateRequired,
}

// 设备类型定义
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceType {
    pub id: String,
    pub name: String,
    pub description: String,
    pub manufacturer: String,
    pub model: String,
    pub properties_schema: HashMap<String, PropertySchema>,
    pub capabilities_schema: Vec<CapabilitySchema>,
    pub firmware_support: bool,
    pub metadata: HashMap<String, String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PropertySchema {
    pub data_type: DataType,
    pub required: bool,
    pub default_value: Option<serde_json::Value>,
    pub unit: Option<String>,
    pub description: Option<String>,
    pub constraints: Option<PropertyConstraints>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PropertyConstraints {
    pub min_value: Option<f64>,
    pub max_value: Option<f64>,
    pub allowed_values: Option<Vec<serde_json::Value>>,
    pub pattern: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CapabilitySchema {
    pub name: String,
    pub capability_type: CapabilityType,
    pub parameters_schema: HashMap<String, ParameterSchema>,
    pub description: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ParameterSchema {
    pub data_type: DataType,
    pub required: bool,
    pub default_value: Option<serde_json::Value>,
    pub description: Option<String>,
}
```

### 2. 设备注册器

```rust
// 设备注册器
pub struct DeviceRegistrar {
    device_manager: Arc<DeviceManager>,
    discovery_service: Arc<DeviceDiscoveryService>,
    validation_service: Arc<DeviceValidationService>,
}

impl DeviceRegistrar {
    pub fn new(device_manager: Arc<DeviceManager>) -> Self {
        Self {
            device_manager,
            discovery_service: Arc::new(DeviceDiscoveryService::new()),
            validation_service: Arc::new(DeviceValidationService::new()),
        }
    }

    // 注册设备
    pub async fn register_device(&self, registration: DeviceRegistration) -> Result<Device, DeviceError> {
        // 验证设备信息
        self.validation_service.validate_registration(&registration).await?;
        
        // 检查设备是否已存在
        let devices = self.device_manager.devices.read().await;
        if devices.contains_key(&registration.device_id) {
            return Err(DeviceError::DeviceAlreadyExists(registration.device_id));
        }
        
        // 获取设备类型
        let device_types = self.device_manager.device_types.read().await;
        let device_type = device_types.get(&registration.device_type)
            .ok_or(DeviceError::DeviceTypeNotFound(registration.device_type.clone()))?;
        
        // 创建设备实例
        let device = Device {
            id: registration.device_id.clone(),
            name: registration.name,
            device_type: registration.device_type,
            status: DeviceStatus::Offline,
            location: registration.location,
            properties: self.initialize_properties(&device_type, &registration.properties),
            capabilities: self.initialize_capabilities(&device_type, &registration.capabilities),
            firmware: FirmwareInfo {
                current_version: registration.firmware_version,
                target_version: None,
                update_status: FirmwareUpdateStatus::UpToDate,
                last_update: None,
                checksum: None,
            },
            metadata: registration.metadata,
            created_at: Utc::now(),
            updated_at: Utc::now(),
            last_seen: None,
        };
        
        // 保存设备
        let mut devices = self.device_manager.devices.write().await;
        devices.insert(device.id.clone(), device.clone());
        
        // 发布设备注册事件
        self.device_manager.event_bus.publish(DeviceEvent::Registered(device.id.clone())).await?;
        
        Ok(device)
    }

    // 自动发现设备
    pub async fn discover_devices(&self) -> Result<Vec<DiscoveredDevice>, DeviceError> {
        let discovered_devices = self.discovery_service.discover_devices().await?;
        
        for discovered_device in &discovered_devices {
            // 尝试自动注册发现的设备
            if let Ok(registration) = self.create_registration_from_discovery(discovered_device).await {
                let _ = self.register_device(registration).await;
            }
        }
        
        Ok(discovered_devices)
    }

    // 从发现信息创建注册信息
    async fn create_registration_from_discovery(&self, discovered: &DiscoveredDevice) -> Result<DeviceRegistration, DeviceError> {
        let device_types = self.device_manager.device_types.read().await;
        
        // 尝试匹配设备类型
        let device_type = device_types.values()
            .find(|dt| dt.manufacturer == discovered.manufacturer && dt.model == discovered.model)
            .ok_or(DeviceError::DeviceTypeNotFound("unknown".to_string()))?;
        
        Ok(DeviceRegistration {
            device_id: discovered.device_id.clone(),
            name: discovered.name.clone(),
            device_type: device_type.id.clone(),
            location: discovered.location.clone(),
            properties: discovered.properties.clone(),
            capabilities: discovered.capabilities.clone(),
            firmware_version: discovered.firmware_version.clone(),
            metadata: discovered.metadata.clone(),
        })
    }

    // 初始化设备属性
    fn initialize_properties(&self, device_type: &DeviceType, provided_properties: &HashMap<String, serde_json::Value>) -> HashMap<String, DeviceProperty> {
        let mut properties = HashMap::new();
        
        for (name, schema) in &device_type.properties_schema {
            let value = provided_properties.get(name)
                .cloned()
                .unwrap_or_else(|| schema.default_value.clone().unwrap_or(json!(null)));
            
            properties.insert(name.clone(), DeviceProperty {
                name: name.clone(),
                value,
                data_type: schema.data_type.clone(),
                unit: schema.unit.clone(),
                description: schema.description.clone(),
                writable: true, // 默认可写
                last_updated: Utc::now(),
            });
        }
        
        properties
    }

    // 初始化设备能力
    fn initialize_capabilities(&self, device_type: &DeviceType, provided_capabilities: &[DeviceCapability]) -> Vec<DeviceCapability> {
        let mut capabilities = Vec::new();
        
        for schema in &device_type.capabilities_schema {
            if let Some(provided) = provided_capabilities.iter().find(|c| c.name == schema.name) {
                capabilities.push(provided.clone());
            } else {
                capabilities.push(DeviceCapability {
                    name: schema.name.clone(),
                    capability_type: schema.capability_type.clone(),
                    parameters: HashMap::new(),
                    description: schema.description.clone(),
                });
            }
        }
        
        capabilities
    }
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceRegistration {
    pub device_id: String,
    pub name: String,
    pub device_type: String,
    pub location: Option<Location>,
    pub properties: HashMap<String, serde_json::Value>,
    pub capabilities: Vec<DeviceCapability>,
    pub firmware_version: String,
    pub metadata: HashMap<String, String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DiscoveredDevice {
    pub device_id: String,
    pub name: String,
    pub manufacturer: String,
    pub model: String,
    pub firmware_version: String,
    pub location: Option<Location>,
    pub properties: HashMap<String, serde_json::Value>,
    pub capabilities: Vec<DeviceCapability>,
    pub metadata: HashMap<String, String>,
}
```

### 3. 设备状态监控器

```rust
// 设备状态监控器
pub struct DeviceStatusMonitor {
    device_manager: Arc<DeviceManager>,
    health_checker: Arc<DeviceHealthChecker>,
    event_bus: Arc<EventBus>,
}

impl DeviceStatusMonitor {
    pub fn new(device_manager: Arc<DeviceManager>) -> Self {
        Self {
            device_manager,
            health_checker: Arc::new(DeviceHealthChecker::new()),
            event_bus: Arc::new(EventBus::new()),
        }
    }

    // 更新设备状态
    pub async fn update_device_status(&self, device_id: &str, status: DeviceStatus) -> Result<(), DeviceError> {
        let mut devices = self.device_manager.devices.write().await;
        
        if let Some(device) = devices.get_mut(device_id) {
            let old_status = device.status.clone();
            device.status = status;
            device.updated_at = Utc::now();
            device.last_seen = Some(Utc::now());
            
            // 发布状态变更事件
            if old_status != status {
                self.event_bus.publish(DeviceEvent::StatusChanged(
                    device_id.to_string(),
                    old_status,
                    status,
                )).await?;
            }
        }
        
        Ok(())
    }

    // 更新设备属性
    pub async fn update_device_property(&self, device_id: &str, property_name: &str, value: serde_json::Value) -> Result<(), DeviceError> {
        let mut devices = self.device_manager.devices.write().await;
        
        if let Some(device) = devices.get_mut(device_id) {
            if let Some(property) = device.properties.get_mut(property_name) {
                property.value = value;
                property.last_updated = Utc::now();
                device.updated_at = Utc::now();
                device.last_seen = Some(Utc::now());
                
                // 发布属性更新事件
                self.event_bus.publish(DeviceEvent::PropertyUpdated(
                    device_id.to_string(),
                    property_name.to_string(),
                )).await?;
            }
        }
        
        Ok(())
    }

    // 健康检查
    pub async fn perform_health_check(&self, device_id: &str) -> Result<DeviceHealth, DeviceError> {
        let devices = self.device_manager.devices.read().await;
        let device = devices.get(device_id)
            .ok_or(DeviceError::DeviceNotFound(device_id.to_string()))?;
        
        let health = self.health_checker.check_device_health(device).await?;
        
        // 更新设备状态
        if health.status != device.status {
            self.update_device_status(device_id, health.status.clone()).await?;
        }
        
        Ok(health)
    }

    // 批量健康检查
    pub async fn perform_bulk_health_check(&self) -> Result<Vec<DeviceHealth>, DeviceError> {
        let devices = self.device_manager.devices.read().await;
        let mut health_results = Vec::new();
        
        for device in devices.values() {
            if let Ok(health) = self.health_checker.check_device_health(device).await {
                health_results.push(health);
            }
        }
        
        Ok(health_results)
    }
}

#[derive(Debug, Clone)]
pub struct DeviceHealth {
    pub device_id: String,
    pub status: DeviceStatus,
    pub health_score: f64,
    pub last_check: DateTime<Utc>,
    pub issues: Vec<HealthIssue>,
}

#[derive(Debug, Clone)]
pub struct HealthIssue {
    pub issue_type: HealthIssueType,
    pub severity: Severity,
    pub description: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone)]
pub enum HealthIssueType {
    Connectivity,
    Performance,
    Firmware,
    Configuration,
    Hardware,
}
```

### 4. 固件管理器

```rust
// 固件管理器
pub struct FirmwareManager {
    firmware_store: Arc<FirmwareStore>,
    update_service: Arc<FirmwareUpdateService>,
    validation_service: Arc<FirmwareValidationService>,
}

impl FirmwareManager {
    pub fn new() -> Self {
        Self {
            firmware_store: Arc::new(FirmwareStore::new()),
            update_service: Arc::new(FirmwareUpdateService::new()),
            validation_service: Arc::new(FirmwareValidationService::new()),
        }
    }

    // 上传固件
    pub async fn upload_firmware(&self, firmware: FirmwareUpload) -> Result<Firmware, DeviceError> {
        // 验证固件
        self.validation_service.validate_firmware(&firmware).await?;
        
        // 存储固件
        let firmware_info = self.firmware_store.store_firmware(firmware).await?;
        
        Ok(firmware_info)
    }

    // 检查设备固件更新
    pub async fn check_firmware_update(&self, device_id: &str) -> Result<Option<FirmwareUpdate>, DeviceError> {
        let devices = self.device_manager.devices.read().await;
        let device = devices.get(device_id)
            .ok_or(DeviceError::DeviceNotFound(device_id.to_string()))?;
        
        let device_types = self.device_manager.device_types.read().await;
        let device_type = device_types.get(&device.device_type)
            .ok_or(DeviceError::DeviceTypeNotFound(device.device_type.clone()))?;
        
        if !device_type.firmware_support {
            return Ok(None);
        }
        
        // 查找可用更新
        let available_firmware = self.firmware_store.get_latest_firmware(
            &device_type.manufacturer,
            &device_type.model,
        ).await?;
        
        if let Some(firmware) = available_firmware {
            if firmware.version != device.firmware.current_version {
                return Ok(Some(FirmwareUpdate {
                    device_id: device_id.to_string(),
                    current_version: device.firmware.current_version.clone(),
                    target_version: firmware.version.clone(),
                    firmware: firmware,
                }));
            }
        }
        
        Ok(None)
    }

    // 执行固件更新
    pub async fn perform_firmware_update(&self, update: FirmwareUpdate) -> Result<FirmwareUpdateResult, DeviceError> {
        // 更新设备固件状态
        let mut devices = self.device_manager.devices.write().await;
        if let Some(device) = devices.get_mut(&update.device_id) {
            device.firmware.update_status = FirmwareUpdateStatus::Updating;
            device.firmware.target_version = Some(update.target_version.clone());
        }
        
        // 执行更新
        let result = self.update_service.update_device_firmware(&update).await?;
        
        // 更新设备固件信息
        if let Some(device) = devices.get_mut(&update.device_id) {
            if result.success {
                device.firmware.current_version = update.target_version;
                device.firmware.update_status = FirmwareUpdateStatus::UpToDate;
                device.firmware.last_update = Some(Utc::now());
                device.firmware.target_version = None;
            } else {
                device.firmware.update_status = FirmwareUpdateStatus::UpdateFailed;
                device.firmware.target_version = None;
            }
        }
        
        Ok(result)
    }
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Firmware {
    pub id: String,
    pub version: String,
    pub manufacturer: String,
    pub model: String,
    pub file_path: String,
    pub file_size: u64,
    pub checksum: String,
    pub release_notes: Option<String>,
    pub compatibility: Vec<String>,
    pub created_at: DateTime<Utc>,
}

#[derive(Debug, Clone)]
pub struct FirmwareUpdate {
    pub device_id: String,
    pub current_version: String,
    pub target_version: String,
    pub firmware: Firmware,
}

#[derive(Debug, Clone)]
pub struct FirmwareUpdateResult {
    pub success: bool,
    pub error_message: Option<String>,
    pub update_time: Duration,
}
```

### 5. 设备控制器

```rust
// 设备控制器
pub struct DeviceController {
    device_manager: Arc<DeviceManager>,
    protocol_adapters: HashMap<String, Arc<dyn ProtocolAdapter>>,
    command_queue: Arc<CommandQueue>,
}

impl DeviceController {
    pub fn new(device_manager: Arc<DeviceManager>) -> Self {
        Self {
            device_manager,
            protocol_adapters: HashMap::new(),
            command_queue: Arc::new(CommandQueue::new()),
        }
    }

    // 发送命令到设备
    pub async fn send_command(&self, device_id: &str, command: DeviceCommand) -> Result<CommandResult, DeviceError> {
        let devices = self.device_manager.devices.read().await;
        let device = devices.get(device_id)
            .ok_or(DeviceError::DeviceNotFound(device_id.to_string()))?;
        
        // 验证命令
        self.validate_command(device, &command).await?;
        
        // 获取协议适配器
        let adapter = self.get_protocol_adapter(device).await?;
        
        // 发送命令
        let result = adapter.send_command(device_id, &command).await?;
        
        // 处理响应
        self.handle_command_response(device_id, &command, &result).await?;
        
        Ok(result)
    }

    // 批量发送命令
    pub async fn send_bulk_commands(&self, commands: Vec<BulkCommand>) -> Result<Vec<CommandResult>, DeviceError> {
        let mut results = Vec::new();
        
        for bulk_command in commands {
            for device_id in &bulk_command.device_ids {
                let command = DeviceCommand {
                    command_type: bulk_command.command_type.clone(),
                    parameters: bulk_command.parameters.clone(),
                    timeout: bulk_command.timeout,
                };
                
                match self.send_command(device_id, command).await {
                    Ok(result) => results.push(result),
                    Err(e) => {
                        results.push(CommandResult {
                            success: false,
                            response: None,
                            error: Some(e.to_string()),
                            execution_time: Duration::from_millis(0),
                        });
                    }
                }
            }
        }
        
        Ok(results)
    }

    // 获取设备状态
    pub async fn get_device_status(&self, device_id: &str) -> Result<DeviceStatus, DeviceError> {
        let devices = self.device_manager.devices.read().await;
        let device = devices.get(device_id)
            .ok_or(DeviceError::DeviceNotFound(device_id.to_string()))?;
        
        Ok(device.status.clone())
    }

    // 获取设备属性
    pub async fn get_device_properties(&self, device_id: &str) -> Result<HashMap<String, DeviceProperty>, DeviceError> {
        let devices = self.device_manager.devices.read().await;
        let device = devices.get(device_id)
            .ok_or(DeviceError::DeviceNotFound(device_id.to_string()))?;
        
        Ok(device.properties.clone())
    }

    // 设置设备属性
    pub async fn set_device_property(&self, device_id: &str, property_name: &str, value: serde_json::Value) -> Result<(), DeviceError> {
        let command = DeviceCommand {
            command_type: CommandType::SetProperty,
            parameters: HashMap::from([
                ("property_name".to_string(), json!(property_name)),
                ("value".to_string(), value),
            ]),
            timeout: Duration::from_secs(30),
        };
        
        let result = self.send_command(device_id, command).await?;
        
        if result.success {
            // 更新本地属性
            let status_monitor = DeviceStatusMonitor::new(self.device_manager.clone());
            status_monitor.update_device_property(device_id, property_name, value).await?;
        }
        
        Ok(())
    }
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeviceCommand {
    pub command_type: CommandType,
    pub parameters: HashMap<String, serde_json::Value>,
    pub timeout: Duration,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum CommandType {
    GetStatus,
    SetProperty,
    ExecuteAction,
    Restart,
    Reset,
    Custom(String),
}

#[derive(Debug, Clone)]
pub struct CommandResult {
    pub success: bool,
    pub response: Option<serde_json::Value>,
    pub error: Option<String>,
    pub execution_time: Duration,
}

#[derive(Debug, Clone)]
pub struct BulkCommand {
    pub device_ids: Vec<String>,
    pub command_type: CommandType,
    pub parameters: HashMap<String, serde_json::Value>,
    pub timeout: Duration,
}
```

### 6. 设备管理API

```rust
#[derive(Deserialize)]
pub struct RegisterDeviceRequest {
    pub device_id: String,
    pub name: String,
    pub device_type: String,
    pub location: Option<Location>,
    pub properties: HashMap<String, serde_json::Value>,
    pub capabilities: Vec<DeviceCapability>,
    pub firmware_version: String,
    pub metadata: HashMap<String, String>,
}

#[derive(Deserialize)]
pub struct SendCommandRequest {
    pub command_type: CommandType,
    pub parameters: HashMap<String, serde_json::Value>,
    pub timeout: Option<Duration>,
}

#[derive(Serialize)]
pub struct DeviceResponse {
    pub device: Device,
    pub health: Option<DeviceHealth>,
}

// 设备管理API路由
pub fn device_management_routes() -> Router {
    Router::new()
        .route("/devices", post(register_device))
        .route("/devices", get(list_devices))
        .route("/devices/:id", get(get_device))
        .route("/devices/:id", put(update_device))
        .route("/devices/:id", delete(delete_device))
        .route("/devices/:id/status", get(get_device_status))
        .route("/devices/:id/health", get(get_device_health))
        .route("/devices/:id/command", post(send_command))
        .route("/devices/:id/properties", get(get_device_properties))
        .route("/devices/:id/properties/:name", put(set_device_property))
        .route("/devices/:id/firmware/check", post(check_firmware_update))
        .route("/devices/:id/firmware/update", post(update_firmware))
        .route("/devices/discover", post(discover_devices))
        .route("/device-types", post(register_device_type))
        .route("/device-types", get(list_device_types))
}

async fn register_device(
    Json(request): Json<RegisterDeviceRequest>,
    State(device_manager): State<Arc<DeviceManager>>,
) -> Result<Json<DeviceResponse>, StatusCode> {
    let registrar = DeviceRegistrar::new(device_manager.clone());
    
    let registration = DeviceRegistration {
        device_id: request.device_id,
        name: request.name,
        device_type: request.device_type,
        location: request.location,
        properties: request.properties,
        capabilities: request.capabilities,
        firmware_version: request.firmware_version,
        metadata: request.metadata,
    };
    
    let device = registrar.register_device(registration).await
        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
    
    let health = None; // 可以在这里执行健康检查
    
    Ok(Json(DeviceResponse { device, health }))
}

async fn send_command(
    Path(device_id): Path<String>,
    Json(request): Json<SendCommandRequest>,
    State(device_manager): State<Arc<DeviceManager>>,
) -> Result<Json<CommandResult>, StatusCode> {
    let controller = DeviceController::new(device_manager);
    
    let command = DeviceCommand {
        command_type: request.command_type,
        parameters: request.parameters,
        timeout: request.timeout.unwrap_or(Duration::from_secs(30)),
    };
    
    let result = controller.send_command(&device_id, command).await
        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
    
    Ok(Json(result))
}

async fn get_device_health(
    Path(device_id): Path<String>,
    State(device_manager): State<Arc<DeviceManager>>,
) -> Result<Json<DeviceHealth>, StatusCode> {
    let monitor = DeviceStatusMonitor::new(device_manager);
    
    let health = monitor.perform_health_check(&device_id).await
        .map_err(|_| StatusCode::NOT_FOUND)?;
    
    Ok(Json(health))
}
```

## 使用示例

### 1. 注册设备类型

```rust
#[tokio::main]
async fn main() {
    let device_manager = Arc::new(DeviceManager::new());
    
    // 注册温度传感器设备类型
    let temperature_sensor_type = DeviceType {
        id: "temperature-sensor".to_string(),
        name: "温度传感器".to_string(),
        description: "DHT22温度湿度传感器".to_string(),
        manufacturer: "Adafruit".to_string(),
        model: "DHT22".to_string(),
        properties_schema: HashMap::from([
            ("temperature".to_string(), PropertySchema {
                data_type: DataType::Float,
                required: true,
                default_value: Some(json!(0.0)),
                unit: Some("°C".to_string()),
                description: Some("当前温度".to_string()),
                constraints: Some(PropertyConstraints {
                    min_value: Some(-40.0),
                    max_value: Some(80.0),
                    allowed_values: None,
                    pattern: None,
                }),
            }),
            ("humidity".to_string(), PropertySchema {
                data_type: DataType::Float,
                required: true,
                default_value: Some(json!(0.0)),
                unit: Some("%".to_string()),
                description: Some("当前湿度".to_string()),
                constraints: Some(PropertyConstraints {
                    min_value: Some(0.0),
                    max_value: Some(100.0),
                    allowed_values: None,
                    pattern: None,
                }),
            }),
        ]),
        capabilities_schema: vec![
            CapabilitySchema {
                name: "read_sensor".to_string(),
                capability_type: CapabilityType::Sensor,
                parameters_schema: HashMap::new(),
                description: Some("读取传感器数据".to_string()),
            },
        ],
        firmware_support: true,
        metadata: HashMap::new(),
    };
    
    let mut device_types = device_manager.device_types.write().await;
    device_types.insert(temperature_sensor_type.id.clone(), temperature_sensor_type);
    
    println!("温度传感器设备类型注册成功");
}
```

### 2. 注册设备

```rust
// 注册设备
async fn register_temperature_sensor(device_manager: Arc<DeviceManager>) {
    let registrar = DeviceRegistrar::new(device_manager.clone());
    
    let registration = DeviceRegistration {
        device_id: "sensor-001".to_string(),
        name: "客厅温度传感器".to_string(),
        device_type: "temperature-sensor".to_string(),
        location: Some(Location {
            latitude: 39.9042,
            longitude: 116.4074,
            altitude: Some(50.0),
            address: Some("北京市朝阳区".to_string()),
        }),
        properties: HashMap::from([
            ("temperature".to_string(), json!(25.5)),
            ("humidity".to_string(), json!(60.0)),
        ]),
        capabilities: vec![
            DeviceCapability {
                name: "read_sensor".to_string(),
                capability_type: CapabilityType::Sensor,
                parameters: HashMap::new(),
                description: Some("读取传感器数据".to_string()),
            },
        ],
        firmware_version: "1.0.0".to_string(),
        metadata: HashMap::from([
            ("room".to_string(), "客厅".to_string()),
            ("installation_date".to_string(), "2024-01-01".to_string()),
        ]),
    };
    
    let device = registrar.register_device(registration).await.unwrap();
    println!("设备注册成功: {}", device.id);
}
```

### 3. 设备控制和监控

```rust
// 设备控制和监控
async fn device_control_and_monitoring(device_manager: Arc<DeviceManager>) {
    let controller = DeviceController::new(device_manager.clone());
    let monitor = DeviceStatusMonitor::new(device_manager.clone());
    
    // 获取设备状态
    let status = controller.get_device_status("sensor-001").await.unwrap();
    println!("设备状态: {:?}", status);
    
    // 执行健康检查
    let health = monitor.perform_health_check("sensor-001").await.unwrap();
    println!("设备健康度: {}", health.health_score);
    
    // 读取传感器数据
    let command = DeviceCommand {
        command_type: CommandType::ExecuteAction,
        parameters: HashMap::from([
            ("action".to_string(), json!("read_sensor")),
        ]),
        timeout: Duration::from_secs(10),
    };
    
    let result = controller.send_command("sensor-001", command).await.unwrap();
    if result.success {
        println!("传感器数据: {:?}", result.response);
    } else {
        println!("命令执行失败: {:?}", result.error);
    }
    
    // 更新设备属性
    monitor.update_device_property("sensor-001", "temperature", json!(26.0)).await.unwrap();
    println!("设备属性已更新");
}
```

## 核心特性

1. **设备注册**: 支持设备类型定义和设备实例注册
2. **自动发现**: 支持设备自动发现和注册
3. **状态监控**: 实时监控设备状态和健康度
4. **属性管理**: 动态管理设备属性和配置
5. **固件管理**: 支持固件版本管理和更新
6. **设备控制**: 支持设备命令发送和响应处理
7. **协议适配**: 支持多种设备协议
8. **事件系统**: 基于事件的设备状态变更通知
9. **API接口**: RESTful API支持
10. **生命周期管理**: 完整的设备生命周期管理

这个物联网设备管理实现提供了完整的设备注册、监控、控制和管理功能，支持大规模设备部署和管理。
