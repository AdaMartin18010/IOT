# 协议适配器管理器实现

## 概述

协议适配器管理器负责注册、初始化和管理不同的协议适配器，提供统一的接口来访问各种IoT协议。

## 核心组件

### 1. 适配器管理器

#### Rust实现

```rust
use std::collections::HashMap;
use std::sync::{Arc, RwLock};
use tokio::sync::mpsc;
use serde::{Deserialize, Serialize};
use async_trait::async_trait;

/// 适配器状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum AdapterStatus {
    Initialized,
    Running,
    Stopped,
    Error(String),
}

/// 适配器信息
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AdapterInfo {
    pub id: String,
    pub name: String,
    pub protocol_type: ProtocolType,
    pub status: AdapterStatus,
    pub config: AdapterConfig,
    pub created_at: chrono::DateTime<chrono::Utc>,
    pub updated_at: chrono::DateTime<chrono::Utc>,
}

/// 适配器管理器
pub struct AdapterManager {
    adapters: Arc<RwLock<HashMap<String, Arc<dyn ProtocolAdapter>>>>,
    adapter_info: Arc<RwLock<HashMap<String, AdapterInfo>>>,
    config: AdapterManagerConfig,
    event_sender: mpsc::Sender<AdapterEvent>,
}

impl AdapterManager {
    pub fn new(config: AdapterManagerConfig) -> Self {
        let (event_sender, _) = mpsc::channel(1000);
        
        Self {
            adapters: Arc::new(RwLock::new(HashMap::new())),
            adapter_info: Arc::new(RwLock::new(HashMap::new())),
            config,
            event_sender,
        }
    }

    /// 注册适配器
    pub async fn register_adapter(
        &self,
        id: String,
        adapter: Arc<dyn ProtocolAdapter>,
        config: AdapterConfig,
    ) -> Result<(), Box<dyn std::error::Error>> {
        let adapter_info = AdapterInfo {
            id: id.clone(),
            name: adapter.get_name().to_string(),
            protocol_type: adapter.protocol_type(),
            status: AdapterStatus::Initialized,
            config,
            created_at: chrono::Utc::now(),
            updated_at: chrono::Utc::now(),
        };

        {
            let mut adapters = self.adapters.write().unwrap();
            adapters.insert(id.clone(), adapter);
        }

        {
            let mut adapter_info_map = self.adapter_info.write().unwrap();
            adapter_info_map.insert(id.clone(), adapter_info);
        }

        // 发送注册事件
        let _ = self.event_sender.send(AdapterEvent::AdapterRegistered { id }).await;

        Ok(())
    }

    /// 初始化适配器
    pub async fn initialize_adapter(&self, id: &str) -> Result<(), Box<dyn std::error::Error>> {
        let adapter = {
            let adapters = self.adapters.read().unwrap();
            adapters.get(id).cloned()
        };

        if let Some(adapter) = adapter {
            let config = {
                let adapter_info = self.adapter_info.read().unwrap();
                adapter_info.get(id).map(|info| info.config.clone())
            };

            if let Some(config) = config {
                adapter.initialize(config).await?;
                
                // 更新状态
                {
                    let mut adapter_info = self.adapter_info.write().unwrap();
                    if let Some(info) = adapter_info.get_mut(id) {
                        info.status = AdapterStatus::Running;
                        info.updated_at = chrono::Utc::now();
                    }
                }

                // 发送初始化事件
                let _ = self.event_sender.send(AdapterEvent::AdapterInitialized { 
                    id: id.to_string() 
                }).await;
            }
        }

        Ok(())
    }

    /// 启动适配器
    pub async fn start_adapter(&self, id: &str) -> Result<(), Box<dyn std::error::Error>> {
        let adapter = {
            let adapters = self.adapters.read().unwrap();
            adapters.get(id).cloned()
        };

        if let Some(adapter) = adapter {
            adapter.start().await?;
            
            // 更新状态
            {
                let mut adapter_info = self.adapter_info.write().unwrap();
                if let Some(info) = adapter_info.get_mut(id) {
                    info.status = AdapterStatus::Running;
                    info.updated_at = chrono::Utc::now();
                }
            }

            // 发送启动事件
            let _ = self.event_sender.send(AdapterEvent::AdapterStarted { 
                id: id.to_string() 
            }).await;
        }

        Ok(())
    }

    /// 停止适配器
    pub async fn stop_adapter(&self, id: &str) -> Result<(), Box<dyn std::error::Error>> {
        let adapter = {
            let adapters = self.adapters.read().unwrap();
            adapters.get(id).cloned()
        };

        if let Some(adapter) = adapter {
            adapter.stop().await?;
            
            // 更新状态
            {
                let mut adapter_info = self.adapter_info.write().unwrap();
                if let Some(info) = adapter_info.get_mut(id) {
                    info.status = AdapterStatus::Stopped;
                    info.updated_at = chrono::Utc::now();
                }
            }

            // 发送停止事件
            let _ = self.event_sender.send(AdapterEvent::AdapterStopped { 
                id: id.to_string() 
            }).await;
        }

        Ok(())
    }

    /// 获取适配器
    pub fn get_adapter(&self, id: &str) -> Option<Arc<dyn ProtocolAdapter>> {
        let adapters = self.adapters.read().unwrap();
        adapters.get(id).cloned()
    }

    /// 获取适配器信息
    pub fn get_adapter_info(&self, id: &str) -> Option<AdapterInfo> {
        let adapter_info = self.adapter_info.read().unwrap();
        adapter_info.get(id).cloned()
    }

    /// 获取所有适配器信息
    pub fn get_all_adapters(&self) -> Vec<AdapterInfo> {
        let adapter_info = self.adapter_info.read().unwrap();
        adapter_info.values().cloned().collect()
    }

    /// 按协议类型获取适配器
    pub fn get_adapters_by_type(&self, protocol_type: ProtocolType) -> Vec<Arc<dyn ProtocolAdapter>> {
        let adapters = self.adapters.read().unwrap();
        adapters
            .values()
            .filter(|adapter| adapter.protocol_type() == protocol_type)
            .cloned()
            .collect()
    }

    /// 移除适配器
    pub async fn remove_adapter(&self, id: &str) -> Result<(), Box<dyn std::error::Error>> {
        // 先停止适配器
        self.stop_adapter(id).await?;

        // 从映射中移除
        {
            let mut adapters = self.adapters.write().unwrap();
            adapters.remove(id);
        }

        {
            let mut adapter_info = self.adapter_info.write().unwrap();
            adapter_info.remove(id);
        }

        // 发送移除事件
        let _ = self.event_sender.send(AdapterEvent::AdapterRemoved { 
            id: id.to_string() 
        }).await;

        Ok(())
    }

    /// 健康检查
    pub async fn health_check(&self) -> HashMap<String, AdapterHealth> {
        let mut health_status = HashMap::new();
        let adapters = {
            let adapters = self.adapters.read().unwrap();
            adapters.clone()
        };

        for (id, adapter) in adapters {
            match adapter.health_check().await {
                Ok(health) => {
                    health_status.insert(id, health);
                }
                Err(e) => {
                    health_status.insert(id, AdapterHealth {
                        is_healthy: false,
                        error: Some(e.to_string()),
                        last_check: chrono::Utc::now(),
                    });
                }
            }
        }

        health_status
    }
}

/// 适配器事件
#[derive(Debug, Clone)]
pub enum AdapterEvent {
    AdapterRegistered { id: String },
    AdapterInitialized { id: String },
    AdapterStarted { id: String },
    AdapterStopped { id: String },
    AdapterRemoved { id: String },
    AdapterError { id: String, error: String },
}

/// 适配器健康状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AdapterHealth {
    pub is_healthy: bool,
    pub error: Option<String>,
    pub last_check: chrono::DateTime<chrono::Utc>,
}

/// 适配器管理器配置
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AdapterManagerConfig {
    pub max_adapters: usize,
    pub health_check_interval: std::time::Duration,
    pub auto_restart: bool,
    pub log_level: String,
}
```

#### Go实现

```go
package adapter

import (
    "context"
    "fmt"
    "sync"
    "time"
    "encoding/json"
)

// AdapterStatus 适配器状态
type AdapterStatus string

const (
    AdapterStatusInitialized AdapterStatus = "initialized"
    AdapterStatusRunning     AdapterStatus = "running"
    AdapterStatusStopped     AdapterStatus = "stopped"
    AdapterStatusError       AdapterStatus = "error"
)

// AdapterInfo 适配器信息
type AdapterInfo struct {
    ID           string                 `json:"id"`
    Name         string                 `json:"name"`
    ProtocolType ProtocolType          `json:"protocol_type"`
    Status       AdapterStatus         `json:"status"`
    Config       AdapterConfig         `json:"config"`
    CreatedAt    time.Time             `json:"created_at"`
    UpdatedAt    time.Time             `json:"updated_at"`
}

// AdapterManager 适配器管理器
type AdapterManager struct {
    adapters     map[string]ProtocolAdapter
    adapterInfo  map[string]AdapterInfo
    config       AdapterManagerConfig
    eventChan    chan AdapterEvent
    mu           sync.RWMutex
    ctx          context.Context
    cancel       context.CancelFunc
}

// NewAdapterManager 创建适配器管理器
func NewAdapterManager(config AdapterManagerConfig) *AdapterManager {
    ctx, cancel := context.WithCancel(context.Background())
    
    return &AdapterManager{
        adapters:    make(map[string]ProtocolAdapter),
        adapterInfo: make(map[string]AdapterInfo),
        config:      config,
        eventChan:   make(chan AdapterEvent, 1000),
        ctx:         ctx,
        cancel:      cancel,
    }
}

// RegisterAdapter 注册适配器
func (am *AdapterManager) RegisterAdapter(id string, adapter ProtocolAdapter, config AdapterConfig) error {
    am.mu.Lock()
    defer am.mu.Unlock()

    adapterInfo := AdapterInfo{
        ID:           id,
        Name:         adapter.GetName(),
        ProtocolType: adapter.GetProtocolType(),
        Status:       AdapterStatusInitialized,
        Config:       config,
        CreatedAt:    time.Now(),
        UpdatedAt:    time.Now(),
    }

    am.adapters[id] = adapter
    am.adapterInfo[id] = adapterInfo

    // 发送注册事件
    select {
    case am.eventChan <- AdapterEvent{Type: EventTypeAdapterRegistered, ID: id}:
    default:
    }

    return nil
}

// InitializeAdapter 初始化适配器
func (am *AdapterManager) InitializeAdapter(id string) error {
    am.mu.RLock()
    adapter, exists := am.adapters[id]
    config := am.adapterInfo[id].Config
    am.mu.RUnlock()

    if !exists {
        return fmt.Errorf("adapter %s not found", id)
    }

    if err := adapter.Initialize(config); err != nil {
        am.updateAdapterStatus(id, AdapterStatusError, err.Error())
        return err
    }

    am.updateAdapterStatus(id, AdapterStatusRunning, "")

    // 发送初始化事件
    select {
    case am.eventChan <- AdapterEvent{Type: EventTypeAdapterInitialized, ID: id}:
    default:
    }

    return nil
}

// StartAdapter 启动适配器
func (am *AdapterManager) StartAdapter(id string) error {
    am.mu.RLock()
    adapter, exists := am.adapters[id]
    am.mu.RUnlock()

    if !exists {
        return fmt.Errorf("adapter %s not found", id)
    }

    if err := adapter.Start(); err != nil {
        am.updateAdapterStatus(id, AdapterStatusError, err.Error())
        return err
    }

    am.updateAdapterStatus(id, AdapterStatusRunning, "")

    // 发送启动事件
    select {
    case am.eventChan <- AdapterEvent{Type: EventTypeAdapterStarted, ID: id}:
    default:
    }

    return nil
}

// StopAdapter 停止适配器
func (am *AdapterManager) StopAdapter(id string) error {
    am.mu.RLock()
    adapter, exists := am.adapters[id]
    am.mu.RUnlock()

    if !exists {
        return fmt.Errorf("adapter %s not found", id)
    }

    if err := adapter.Stop(); err != nil {
        am.updateAdapterStatus(id, AdapterStatusError, err.Error())
        return err
    }

    am.updateAdapterStatus(id, AdapterStatusStopped, "")

    // 发送停止事件
    select {
    case am.eventChan <- AdapterEvent{Type: EventTypeAdapterStopped, ID: id}:
    default:
    }

    return nil
}

// GetAdapter 获取适配器
func (am *AdapterManager) GetAdapter(id string) (ProtocolAdapter, bool) {
    am.mu.RLock()
    defer am.mu.RUnlock()
    
    adapter, exists := am.adapters[id]
    return adapter, exists
}

// GetAdapterInfo 获取适配器信息
func (am *AdapterManager) GetAdapterInfo(id string) (AdapterInfo, bool) {
    am.mu.RLock()
    defer am.mu.RUnlock()
    
    info, exists := am.adapterInfo[id]
    return info, exists
}

// GetAllAdapters 获取所有适配器信息
func (am *AdapterManager) GetAllAdapters() []AdapterInfo {
    am.mu.RLock()
    defer am.mu.RUnlock()
    
    adapters := make([]AdapterInfo, 0, len(am.adapterInfo))
    for _, info := range am.adapterInfo {
        adapters = append(adapters, info)
    }
    return adapters
}

// GetAdaptersByType 按协议类型获取适配器
func (am *AdapterManager) GetAdaptersByType(protocolType ProtocolType) []ProtocolAdapter {
    am.mu.RLock()
    defer am.mu.RUnlock()
    
    var adapters []ProtocolAdapter
    for id, adapter := range am.adapters {
        if am.adapterInfo[id].ProtocolType == protocolType {
            adapters = append(adapters, adapter)
        }
    }
    return adapters
}

// RemoveAdapter 移除适配器
func (am *AdapterManager) RemoveAdapter(id string) error {
    // 先停止适配器
    if err := am.StopAdapter(id); err != nil {
        return err
    }

    am.mu.Lock()
    defer am.mu.Unlock()

    delete(am.adapters, id)
    delete(am.adapterInfo, id)

    // 发送移除事件
    select {
    case am.eventChan <- AdapterEvent{Type: EventTypeAdapterRemoved, ID: id}:
    default:
    }

    return nil
}

// HealthCheck 健康检查
func (am *AdapterManager) HealthCheck() map[string]AdapterHealth {
    am.mu.RLock()
    adapters := make(map[string]ProtocolAdapter)
    for id, adapter := range am.adapters {
        adapters[id] = adapter
    }
    am.mu.RUnlock()

    healthStatus := make(map[string]AdapterHealth)
    for id, adapter := range adapters {
        health, err := adapter.HealthCheck()
        if err != nil {
            healthStatus[id] = AdapterHealth{
                IsHealthy: false,
                Error:     err.Error(),
                LastCheck: time.Now(),
            }
        } else {
            healthStatus[id] = health
        }
    }

    return healthStatus
}

// updateAdapterStatus 更新适配器状态
func (am *AdapterManager) updateAdapterStatus(id string, status AdapterStatus, errorMsg string) {
    am.mu.Lock()
    defer am.mu.Unlock()

    if info, exists := am.adapterInfo[id]; exists {
        info.Status = status
        info.UpdatedAt = time.Now()
        am.adapterInfo[id] = info
    }
}

// GetEventChannel 获取事件通道
func (am *AdapterManager) GetEventChannel() <-chan AdapterEvent {
    return am.eventChan
}

// Close 关闭管理器
func (am *AdapterManager) Close() {
    am.cancel()
    close(am.eventChan)
}

// AdapterEvent 适配器事件
type AdapterEvent struct {
    Type EventType `json:"type"`
    ID   string    `json:"id"`
    Data string    `json:"data,omitempty"`
}

// EventType 事件类型
type EventType string

const (
    EventTypeAdapterRegistered  EventType = "adapter_registered"
    EventTypeAdapterInitialized EventType = "adapter_initialized"
    EventTypeAdapterStarted     EventType = "adapter_started"
    EventTypeAdapterStopped     EventType = "adapter_stopped"
    EventTypeAdapterRemoved     EventType = "adapter_removed"
    EventTypeAdapterError       EventType = "adapter_error"
)

// AdapterHealth 适配器健康状态
type AdapterHealth struct {
    IsHealthy bool      `json:"is_healthy"`
    Error     string    `json:"error,omitempty"`
    LastCheck time.Time `json:"last_check"`
}

// AdapterManagerConfig 适配器管理器配置
type AdapterManagerConfig struct {
    MaxAdapters         int           `json:"max_adapters"`
    HealthCheckInterval time.Duration `json:"health_check_interval"`
    AutoRestart         bool          `json:"auto_restart"`
    LogLevel            string        `json:"log_level"`
}
```

### 2. 使用示例

```rust
// Rust示例
#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 创建适配器管理器
    let config = AdapterManagerConfig {
        max_adapters: 100,
        health_check_interval: std::time::Duration::from_secs(30),
        auto_restart: true,
        log_level: "info".to_string(),
    };
    
    let manager = Arc::new(AdapterManager::new(config));

    // 创建并注册OPC UA适配器
    let opc_ua_adapter = Arc::new(OPCUAAdapter::new());
    let opc_ua_config = AdapterConfig {
        endpoint: "opc.tcp://localhost:4840".to_string(),
        security_policy: "Basic256Sha256".to_string(),
        authentication_mode: "Anonymous".to_string(),
        timeout: std::time::Duration::from_secs(30),
        retry_count: 3,
        custom: HashMap::new(),
    };

    manager.register_adapter(
        "opc-ua-001".to_string(),
        opc_ua_adapter,
        opc_ua_config,
    ).await?;

    // 创建并注册MQTT适配器
    let mqtt_adapter = Arc::new(MQTTAdapter::new());
    let mqtt_config = AdapterConfig {
        endpoint: "tcp://localhost:1883".to_string(),
        security_policy: "None".to_string(),
        authentication_mode: "None".to_string(),
        timeout: std::time::Duration::from_secs(10),
        retry_count: 5,
        custom: {
            let mut custom = HashMap::new();
            custom.insert("client_id".to_string(), "iot-gateway".to_string());
            custom.insert("keep_alive".to_string(), "60".to_string());
            custom
        },
    };

    manager.register_adapter(
        "mqtt-001".to_string(),
        mqtt_adapter,
        mqtt_config,
    ).await?;

    // 初始化所有适配器
    manager.initialize_adapter("opc-ua-001").await?;
    manager.initialize_adapter("mqtt-001").await?;

    // 启动所有适配器
    manager.start_adapter("opc-ua-001").await?;
    manager.start_adapter("mqtt-001").await?;

    // 获取适配器信息
    let adapters = manager.get_all_adapters();
    println!("Registered adapters: {:?}", adapters);

    // 健康检查
    let health = manager.health_check().await;
    println!("Health status: {:?}", health);

    // 按协议类型获取适配器
    let mqtt_adapters = manager.get_adapters_by_type(ProtocolType::MQTT);
    println!("MQTT adapters: {}", mqtt_adapters.len());

    Ok(())
}
```

```go
// Go示例
func main() {
    // 创建适配器管理器
    config := AdapterManagerConfig{
        MaxAdapters:         100,
        HealthCheckInterval: 30 * time.Second,
        AutoRestart:         true,
        LogLevel:            "info",
    }
    
    manager := NewAdapterManager(config)

    // 创建并注册OPC UA适配器
    opcUAAdapter := NewOPCUAAdapter()
    opcUAConfig := AdapterConfig{
        Endpoint:           "opc.tcp://localhost:4840",
        SecurityPolicy:     "Basic256Sha256",
        AuthenticationMode: "Anonymous",
        Timeout:            30 * time.Second,
        RetryCount:         3,
        Custom:             make(map[string]string),
    }

    err := manager.RegisterAdapter("opc-ua-001", opcUAAdapter, opcUAConfig)
    if err != nil {
        log.Fatal(err)
    }

    // 创建并注册MQTT适配器
    mqttAdapter := NewMQTTAdapter()
    mqttConfig := AdapterConfig{
        Endpoint:           "tcp://localhost:1883",
        SecurityPolicy:     "None",
        AuthenticationMode: "None",
        Timeout:            10 * time.Second,
        RetryCount:         5,
        Custom: map[string]string{
            "client_id":  "iot-gateway",
            "keep_alive": "60",
        },
    }

    err = manager.RegisterAdapter("mqtt-001", mqttAdapter, mqttConfig)
    if err != nil {
        log.Fatal(err)
    }

    // 初始化所有适配器
    if err := manager.InitializeAdapter("opc-ua-001"); err != nil {
        log.Fatal(err)
    }
    if err := manager.InitializeAdapter("mqtt-001"); err != nil {
        log.Fatal(err)
    }

    // 启动所有适配器
    if err := manager.StartAdapter("opc-ua-001"); err != nil {
        log.Fatal(err)
    }
    if err := manager.StartAdapter("mqtt-001"); err != nil {
        log.Fatal(err)
    }

    // 获取适配器信息
    adapters := manager.GetAllAdapters()
    fmt.Printf("Registered adapters: %+v\n", adapters)

    // 健康检查
    health := manager.HealthCheck()
    fmt.Printf("Health status: %+v\n", health)

    // 按协议类型获取适配器
    mqttAdapters := manager.GetAdaptersByType(ProtocolTypeMQTT)
    fmt.Printf("MQTT adapters: %d\n", len(mqttAdapters))

    // 监听事件
    go func() {
        for event := range manager.GetEventChannel() {
            fmt.Printf("Adapter event: %+v\n", event)
        }
    }()

    // 保持运行
    select {}
}
```

## 总结

协议适配器管理器提供了以下核心功能：

1. **适配器注册管理**：支持动态注册和移除各种协议适配器
2. **生命周期管理**：初始化、启动、停止适配器的完整生命周期
3. **状态监控**：实时跟踪适配器状态和健康信息
4. **事件系统**：提供适配器状态变化的事件通知
5. **配置管理**：统一的配置管理和验证
6. **健康检查**：定期检查适配器健康状态
7. **类型管理**：按协议类型组织和访问适配器

这个实现为IoT网关提供了强大的协议适配能力，支持多种工业协议的统一管理和操作。
